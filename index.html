<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consola CEAM - Gestión de Citas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8B4513;
            --secondary-color: #A0522D;
            --accent-color: #CD853F;
            --light-brown: #DEB887;
            --dark-brown: #654321;
            --success-color: #228B22;
            --warning-color: #DAA520;
            --danger-color: #DC143C;
            --info-color: #4682B4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 100%);
            min-height: 100vh;
        }
        
        .header-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-brown));
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-bar h1 {
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.1);
            min-height: 500px;
        }
        
        .new-registrations {
            background: rgba(222, 184, 135, 0.15);
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 3px 10px rgba(139, 69, 19, 0.1);
        }
        
        .new-registrations h4 {
            color: var(--dark-brown);
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 1.3rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
        }
        
        .registration-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-left: 5px solid transparent;
        }
        
        .registration-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .registration-card.service-cortesia { border-left-color: #4CAF50; }
        .registration-card.service-expertos { border-left-color: #2196F3; }
        .registration-card.service-crisis { border-left-color: #FF9800; }
        .registration-card.service-integral { border-left-color: #9C27B0; }
        .registration-card.service-orientacion { border-left-color: #00BCD4; }
        
        .reg-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .reg-service {
            font-weight: 700;
            color: var(--dark-brown);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .reg-patient-name {
            font-size: 0.95rem;
            color: #555;
        }
        
        .reg-age {
            background: var(--light-brown);
            color: var(--dark-brown);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .reg-body {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        
        .reg-beliefs {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .belief-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .belief-indicators {
            display: flex;
            gap: 8px;
            font-size: 1.3rem;
        }
        
        .check-mark { color: var(--success-color); font-weight: bold; }
        .x-mark { color: var(--danger-color); font-weight: bold; }
        
        .reg-message-section { flex: 1; }
        
        .reg-for-who {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-bottom: 8px;
        }
        
        .reg-for-who span {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .reg-message {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #495057;
            border-left: 3px solid var(--accent-color);
        }
        
        .reg-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        
        .action-buttons { display: flex; gap: 10px; }
        
        .btn-accept {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-accept:hover {
            background: #1e7e34;
            transform: scale(1.05);
        }
        
        .btn-reject {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-reject:hover {
            background: #bd2130;
            transform: scale(1.05);
        }
        
        .invite-section {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .invite-select {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--light-brown);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .btn-send {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .btn-send:hover { background: var(--dark-brown); }
        
        .fc .fc-button-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .fc .fc-button-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .fc th {
            background: var(--light-brown);
            color: var(--dark-brown);
            font-weight: 600;
        }
        
        .fc-day-today { background: rgba(222, 184, 135, 0.2) !important; }
        
        .appointment-event {
            padding: 2px 5px;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .status-Sinprocesar { background: #FFA500; color: white; }
        .status-Registrado { background: var(--warning-color); color: white; }
        .status-Reservado { background: var(--success-color); color: white; }
        .status-Atendida { background: #28a745; color: white; }
        .status-Cancelada { background: var(--danger-color); color: white; }
        
        .patient-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .patient-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -25px -25px 20px -25px;
        }
        
        .patient-id {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .clinical-section {
            background: #FAF7F0;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--accent-color);
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-whatsapp:hover {
            background: #128C7E;
            transform: scale(1.05);
            color: white;
        }
        
        .btn-brown {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark-brown);
            border: none;
            padding: 10px 20px;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--light-brown);
            color: var(--dark-brown);
            font-weight: 600;
            border-radius: 10px 10px 0 0;
        }
        
        @media (max-width: 768px) {
            .reg-body {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .reg-actions { min-width: auto; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="bi bi-heart-pulse-fill"></i>
                Centro de Estudios Avanzados de la Mente
            </h1>
            <div>
                <button class="btn btn-outline-light btn-sm me-2" onclick="exportData()">
                    <i class="bi bi-download"></i> Exportar
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="syncWithAirtable()">
                    <i class="bi bi-arrow-clockwise"></i> Sincronizar
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid p-3">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#calendar-view">
                    <i class="bi bi-calendar3"></i> Calendario
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#list-view">
                    <i class="bi bi-table"></i> Lista de Citas
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#stats-view">
                    <i class="bi bi-graph-up"></i> Estadísticas
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="calendar-view">
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
                
                <div class="new-registrations">
                    <h4><i class="bi bi-person-plus-fill"></i> Nuevos registros</h4>
                    <div id="new-registrations-list">
                        <p class="text-center text-muted">Cargando...</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="list-view">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead style="background: var(--light-brown);">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>WhatsApp</th>
                                        <th>Edad</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="appointments-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="stats-view">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card border-0" style="background: var(--light-brown);">
                            <div class="card-body text-center">
                                <h3 id="total-citas">0</h3>
                                <p class="mb-0">Total Citas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 text-white" style="background: var(--success-color);">
                            <div class="card-body text-center">
                                <h3 id="citas-registrados">0</h3>
                                <p class="mb-0">Registrados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 text-white" style="background: var(--warning-color);">
                            <div class="card-body text-center">
                                <h3 id="citas-reservados">0</h3>
                                <p class="mb-0">Reservados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 text-white" style="background: #FFA500;">
                            <div class="card-body text-center">
                                <h3 id="citas-sin-procesar">0</h3>
                                <p class="mb-0">Sin Procesar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="patientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content patient-card">
                <div class="patient-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="patient-name" class="mb-2">Nombre del Paciente</h3>
                            <span class="patient-id">ID: <span id="patient-id">CEAM-0001</span></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                
                <div class="modal-body">
                    <div class="clinical-section">
                        <h5 class="mb-3" style="color: var(--dark-brown);">
                            <i class="bi bi-person-badge"></i> Información General
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nombre:</label>
                                <input type="text" class="form-control mb-3" id="modal-patient-firstname">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Apellido:</label>
                                <input type="text" class="form-control mb-3" id="modal-patient-lastname">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Email:</label>
                                <input type="email" class="form-control mb-3" id="modal-patient-email">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">WhatsApp:</label>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="modal-patient-phone">
                                    <button class="btn btn-whatsapp" onclick="openWhatsApp()">
                                        <i class="bi bi-whatsapp"></i> Llamar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Fecha de Nacimiento:</label>
                                <input type="date" class="form-control mb-3" id="modal-patient-birthdate">
                            </div>
                        </div>
                    </div>

                    <div class="clinical-section">
                        <h5 class="mb-3" style="color: var(--dark-brown);">
                            <i class="bi bi-calendar-check"></i> Información de la Cita
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Fecha:</label>
                                <input type="date" class="form-control mb-3" id="modal-date">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Estado:</label>
                                <select class="form-select mb-3" id="modal-status">
                                    <option value="Sin procesar">Sin procesar</option>
                                    <option value="Registrado">Registrado</option>
                                    <option value="Reservado">Reservado</option>
                                    <option value="Atendida">Atendida</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Servicio:</label>
                                <input type="text" class="form-control mb-3" id="modal-service" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="clinical-section">
                        <h5 class="mb-3" style="color: var(--dark-brown);">
                            <i class="bi bi-chat-text"></i> Mensaje del Paciente
                        </h5>
                        <textarea class="form-control" rows="3" id="modal-message" readonly></textarea>
                    </div>

                    <div class="clinical-section">
                        <h5 class="mb-3" style="color: var(--dark-brown);">
                            <i class="bi bi-journal-medical"></i> Notas del Asesor
                        </h5>
                        <textarea class="form-control mb-3" rows="4" id="modal-notes" 
                                  placeholder="Agregar notas sobre la sesión..."></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-brown" onclick="savePatientData()">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/es.global.min.js"></script>
    
    <script>
        const AIRTABLE_CONFIG = {
            baseId: 'appxIa7wAGeUdNwoW',
            apiKey: 'patqSwzUMtvFOryhj.9811dc4d2898b650e31a8af2504cf5e493873920e1a6a5b7031507d91072af05',
            tableName: 'Citas'
        };

        let appointments = [];
        let calendar;
        let currentAppointment = null;

        document.addEventListener('DOMContentLoaded', function() {
            initCalendar();
            loadAirtableData();
        });

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día'
                },
                dayMaxEvents: 6,
                moreLinkText: 'más citas',
                eventClick: function(info) {
                    showPatientModal(info.event.extendedProps.appointmentData);
                },
                eventContent: function(arg) {
                    return {
                        html: `<div class="appointment-event status-${arg.event.extendedProps.status.replace(/\s/g, '')}">${arg.event.title}</div>`
                    };
                }
            });
            calendar.render();
        }

        async function loadAirtableData() {
            try {
                showNotification('Cargando datos de Airtable...', 'info');
                
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Error al cargar datos');

                const data = await response.json();
                
                appointments = data.records.map(record => ({
                    id: record.id,
                    name: (record.fields['Nombre'] || '') + ' ' + (record.fields['Apellido'] || ''),
                    firstName: record.fields['Nombre'] || '',
                    lastName: record.fields['Apellido'] || '',
                    email: record.fields['Email'] || '',
                    phone: record.fields['WhatsApp'] || '',
                    birthdate: record.fields['Fecha de Nacimiento'] || '',
                    date: record.fields['Fecha de Cita'] || '',
                    message: record.fields['Mensaje'] || '',
                    status: record.fields['Estado de la Cita'] || 'Sin procesar',
                    service: record.fields['Servicio'] || '',
                    notes: record.fields['Notas del Asesor'] || '',
                    consulta: record.fields['Consulta'] || '',
                    casilla1: record.fields['Casilla1'] || '',
                    casilla2: record.fields['Casilla2'] || '',
                    casilla3: record.fields['Casilla3'] || ''
                }));
                
                updateCalendar();
                updateList();
                updateStats();
                updateNewRegistrationsList();
                
                showNotification('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al cargar datos: ' + error.message, 'danger');
            }
        }

        function updateNewRegistrationsList() {
            const container = document.getElementById('new-registrations-list');
            const newRegs = appointments.filter(a => a.status === 'Sin procesar');
            
            if (newRegs.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay registros nuevos</p>';
                return;
            }

            container.innerHTML = newRegs.map(reg => {
                const age = reg.birthdate ? calculateAge(reg.birthdate) : 'N/A';
                const serviceClass = getServiceClass(reg.service);
                
                let energySymbols = '';
                if (reg.casilla1) energySymbols += '<span class="check-mark">✔</span>';
                if (reg.casilla2) energySymbols += '<span class="check-mark">✔</span>';
                if (reg.casilla3) energySymbols += '<span class="x-mark">✘</span>';

                return `
                    <div class="registration-card service-${serviceClass}" id="reg-${reg.id}">
                        <div class="reg-header">
                            <div>
                                <div class="reg-service">${reg.service || 'Consulta'}</div>
                                <div class="reg-patient-name">${reg.name}</div>
                            </div>
                            <span class="reg-age">${age} años</span>
                        </div>
                        
                        <div class="reg-body">
                            <div class="reg-beliefs">
                                <div class="belief-label">Creencias</div>
                                <div class="belief-indicators">${energySymbols || '-'}</div>
                            </div>
                            
                            <div class="reg-message-section">
                                ${reg.consulta ? `<div class="reg-for-who">Consulta para: <span>${reg.consulta}</span></div>` : ''}
                                <div class="reg-message">${reg.message || 'Sin mensaje'}</div>
                            </div>
                            
                            <div class="reg-actions">
                                <div class="action-buttons">
                                    <button class="btn-accept" onclick="acceptRegistration('${reg.id}')">
                                        <i class="bi bi-check-circle"></i> Aceptar
                                    </button>
                                    <button class="btn-reject" onclick="rejectRegistration('${reg.id}')">
                                        <i class="bi bi-x-circle"></i> Rechazar
                                    </button>
                                </div>
                                <div class="invite-section">
                                    <select class="invite-select" id="action-${reg.id}">
                                        <option value="">Seleccionar acción...</option>
                                        <option value="cortesia">Sesión cortesía 15min</option>
                                        <option value="orientacion">Orientación inicial 5min</option>
                                        <option value="crisis">Gestión crisis 30min</option>
                                        <option value="unica">Sesión única</option>
                                        <option value="integral">Plan integral</option>
                                        <option value="expertos">Expertos clínicos 20min</option>
                                    </select>
                                    <button class="btn-send" onclick="sendInvitation('${reg.id}')">
                                        <i class="bi bi-envelope"></i> Enviar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function acceptRegistration(id) {
            const reg = appointments.find(r => r.id === id);
            if (!reg) return;

            try {
                const element = document.getElementById(`reg-${id}`);
                element.style.transition = 'all 0.5s';
                element.style.opacity = '0.5';
                element.style.transform = 'scale(0.95)';
                
                const response = await fetch
              `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                'Estado de la Cita': 'Registrado'
                            }
                        })
                    }
                );

                if (!response.ok) throw new Error('Error al actualizar');

                setTimeout(() => {
                    reg.status = 'Registrado';
                    updateCalendar();
                    updateList();
                    updateStats();
                    updateNewRegistrationsList();
                    showNotification(`Registro de ${reg.name} aceptado`, 'success');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al aceptar registro', 'danger');
            }
        }

        async function rejectRegistration(id) {
            const reg = appointments.find(r => r.id === id);
            if (!reg) return;
            
            if (!confirm(`¿Está seguro de rechazar el registro de ${reg.name}?`)) return;

            try {
                const element = document.getElementById(`reg-${id}`);
                element.style.transition = 'all 0.5s';
                element.style.opacity = '0';
                element.style.transform = 'translateX(-100%)';
                
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${id}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Error al eliminar');

                setTimeout(() => {
                    appointments = appointments.filter(a => a.id !== id);
                    updateCalendar();
                    updateList();
                    updateStats();
                    updateNewRegistrationsList();
                    showNotification('Registro rechazado y eliminado', 'danger');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al rechazar registro', 'danger');
            }
        }

        function sendInvitation(id) {
            const select = document.getElementById(`action-${id}`);
            const type = select.value;
            
            if (!type) {
                showNotification('Por favor selecciona un tipo de sesión', 'warning');
                return;
            }
            
            const reg = appointments.find(r => r.id === id);
            if (!reg) return;

            select.disabled = true;
            const btn = select.nextElementSibling;
            btn.innerHTML = '<i class="spinner-border spinner-border-sm"></i>';
            
            setTimeout(() => {
                showNotification(`Invitación enviada a ${reg.email}`, 'info');
                select.disabled = false;
                btn.innerHTML = '<i class="bi bi-envelope"></i> Enviar';
                select.value = '';
            }, 1500);
        }

        function updateCalendar() {
            calendar.removeAllEvents();
            
            appointments.filter(a => a.date).forEach(app => {
                const [firstName] = app.name.split(' ');
                
                calendar.addEvent({
                    id: app.id,
                    title: firstName,
                    start: app.date,
                    extendedProps: {
                        status: app.status.replace(/\s/g, ''),
                        appointmentData: app
                    }
                });
            });
        }

        function updateList() {
            const tbody = document.getElementById('appointments-list');
            tbody.innerHTML = appointments.map(app => `
                <tr>
                    <td>${app.date ? formatDate(app.date) : '-'}</td>
                    <td>${app.name}</td>
                    <td>${app.email || '-'}</td>
                    <td>
                        ${app.phone ? `<button class="btn btn-sm btn-whatsapp" onclick="directWhatsApp('${app.phone}')">
                            <i class="bi bi-whatsapp"></i>
                        </button>` : '-'}
                    </td>
                    <td>${app.birthdate ? calculateAge(app.birthdate) : '-'} años</td>
                    <td>
                        <span class="badge status-${app.status.replace(/\s/g, '')}" style="padding: 5px 10px;">
                            ${app.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-brown" onclick='showPatientModal(${JSON.stringify(app).replace(/'/g, "&apos;")})'>
                            <i class="bi bi-eye"></i> Ver
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const total = appointments.length;
            const registrados = appointments.filter(a => a.status === 'Registrado').length;
            const reservados = appointments.filter(a => a.status === 'Reservado').length;
            const sinProcesar = appointments.filter(a => a.status === 'Sin procesar').length;
            
            document.getElementById('total-citas').textContent = total;
            document.getElementById('citas-registrados').textContent = registrados;
            document.getElementById('citas-reservados').textContent = reservados;
            document.getElementById('citas-sin-procesar').textContent = sinProcesar;
        }

        function showPatientModal(appointment) {
            currentAppointment = appointment;
            
            document.getElementById('patient-name').textContent = appointment.name;
            document.getElementById('patient-id').textContent = 'CEAM-' + appointment.id.substring(0, 8);
            document.getElementById('modal-patient-firstname').value = appointment.firstName;
            document.getElementById('modal-patient-lastname').value = appointment.lastName;
            document.getElementById('modal-patient-email').value = appointment.email || '';
            document.getElementById('modal-patient-phone').value = appointment.phone;
            document.getElementById('modal-patient-birthdate').value = appointment.birthdate || '';
            document.getElementById('modal-date').value = appointment.date || '';
            document.getElementById('modal-status').value = appointment.status;
            document.getElementById('modal-service').value = appointment.service || '';
            document.getElementById('modal-message').value = appointment.message;
            document.getElementById('modal-notes').value = appointment.notes || '';
            
            const modal = new bootstrap.Modal(document.getElementById('patientModal'));
            modal.show();
        }

        async function savePatientData() {
            if (!currentAppointment) return;
            
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${currentAppointment.id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: {
                                'Nombre': document.getElementById('modal-patient-firstname').value,
                                'Apellido': document.getElementById('modal-patient-lastname').value,
                                'Email': document.getElementById('modal-patient-email').value,
                                'WhatsApp': document.getElementById('modal-patient-phone').value,
                                'Fecha de Nacimiento': document.getElementById('modal-patient-birthdate').value,
                                'Fecha de Cita': document.getElementById('modal-date').value,
                                'Estado de la Cita': document.getElementById('modal-status').value,
                                'Notas del Asesor': document.getElementById('modal-notes').value
                            }
                        })
                    }
                );

                if (!response.ok) throw new Error('Error al guardar');

                await loadAirtableData();
                bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
                showNotification('Datos guardados correctamente', 'success');

            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al guardar datos', 'danger');
            }
        }

        function openWhatsApp() {
            const phone = document.getElementById('modal-patient-phone').value;
            if (phone) window.open(`https://wa.me/${phone.replace(/[^\d+]/g, '')}`, '_blank');
        }

        function directWhatsApp(phone) {
            if (phone) window.open(`https://wa.me/${phone.replace(/[^\d+]/g, '')}`, '_blank');
        }

        function exportData() {
            const csv = [
                ['Fecha', 'Nombre', 'Apellido', 'Email', 'WhatsApp', 'Estado', 'Servicio'],
                ...appointments.map(a => [
                    a.date || '', a.firstName, a.lastName, a.email || '', 
                    a.phone, a.status, a.service || ''
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `citas_ceam_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function syncWithAirtable() {
            loadAirtableData();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-MX', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function getServiceClass(service) {
            if (!service) return 'cortesia';
            const s = service.toLowerCase();
            if (s.includes('cortesía') || s.includes('cortesia')) return 'cortesia';
            if (s.includes('expertos') || s.includes('clínico')) return 'expertos';
            if (s.includes('crisis')) return 'crisis';
            if (s.includes('integral')) return 'integral';
            if (s.includes('orientación') || s.includes('orientacion')) return 'orientacion';
            return 'cortesia';
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: '#28a745',
                danger: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
